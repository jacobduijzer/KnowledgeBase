name: Build and deploy (Core)
env:
  OUTPUT_FOLDER: .output\
  
on:
  push:
  workflow_dispatch:
  
jobs:
  build_hugo:
    runs-on: ubuntu-latest
    environment: build
    steps:
      - uses: actions/checkout@v3

      - name: Get Hugo Version
        id: hugo-version
        run: |
          HUGO_VERSION=$(./hugo version | sed -r 's/^.*v([0-9]*\.[0-9]*\.[0-9]*).*/\1/')
          echo "::set-output name=HUGO_VERSION::${HUGO_VERSION}"
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: "${{ steps.hugo-version.outputs.HUGO_VERSION }}"
          extended: true

      - name: Build
        if: ${{ inputs.preview == false }}
        run: "hugo --minify --source ./knowledgebase --destination ${{ github.workspace }}/${{ env.OUTPUT_FOLDER }} --config config.toml"

      - name: Build (preview)
        if: ${{ inputs.preview == true }}
        run: hugo --minify --source ./knowledgebase --destination ${{ github.workspace }}/${{ env.OUTPUT_FOLDER }} --config config.toml --buildDrafts --buildFuture --baseURL '/'

      - name: Publish website output
        uses: actions/upload-artifact@v3
        with:
          name: website
          path: ${{ github.workspace }}/${{ env.OUTPUT_FOLDER }}

      - name: Publish blog json
        uses: actions/upload-artifact@v3
        with:
          name: json
          path: ${{ github.workspace }}/${{ env.OUTPUT_FOLDER }}/index.json
